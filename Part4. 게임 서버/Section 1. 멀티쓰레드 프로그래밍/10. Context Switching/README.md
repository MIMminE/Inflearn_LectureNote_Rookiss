# Section 1.10 <Context Switching>

```c#
while (true)
{
    int original = Interlocked.CompareExchange(ref _locked, 1, 0);
		// 세 번째 인자와 값을 비교하여 두 번째 인자로 변경
    if (original == 0)
        break;
}
```

이전 시간에 구현한 SpinLock 로직에서 락을 획득하지 못했을 때 어떤 동작을 하냐에 따라 무작정 기다리는 스핀락 동작이 아닌 ‘**자리에 돌아가 특정 시간 뒤에 다시 오는**’ 방법이 될 수 있다.

자리로 돌아가는 행동을 제공하는 함수로는 `Thread.Sleep`과 `Thread.Yield`가 있다.

```c#
while (true)
{
    int original = Interlocked.CompareExchange(ref _locked, 1, 0);
		// 세 번째 인자와 값을 비교하여 두 번째 인자로 변경
    if (original == 0)
        break;

		Thread.Sleep(1);
		// 지정한 시간(ms) 무조건 휴식
		Thread.Sleep(0);
		// 조건부 양보, 나보다 우선순위 낮으면 양보X, 즉시 재실행될 수 있음
		Thread.Yield();
		// 조건부 양보, 실행이 가능한 쓰레드가 있다면 우선순위에 상관없이 양보함
}
```

💡 **Sleep과 Yield 의 차이**

두 함수 모두 스레드를 일시적으로 중지하거나 다른 스레드에 실행 기회를 양보하는 데 사용되는 공통점은 있지만 약간의 차이가 존재한다.

**Sleep** 

- 지정된 시간동안 스레드를 중지시키며, 해당 시간 이후에 다시 실행시킨다.
- 특정 시간 지연에 사용된다. 예를 들어, 스레드가 특정 작업 수행한 후 일정 시간 동안 대기하고 다음 작업을 시작하는 경우에 사용된다.

**Yield**

- 현재 실행 중인 스레드가 다른 스레드에게 실행 기회를 양보하도록 만든다. 실행이 가능한 다른 스레드가 없을 경우, 즉시 실행될수도 있다.
- 스레드 간의 협력적인 스케줄링을 지원하기 위해 사용된다. 스레드 간 우선 순위에 따라 CPU 점유 시간을 양보하고 스레드 간 균형을 유지한다.

경우에 따라 실행 시간을 양보하는 것이 좋을 수 있다. **(컨텍스트 스위칭을 고려해야 한다)**

## Context Switching

---

다중 작업 시스템에서 스레드 또는 프로세스 간에 CPU 제어권을 전환하는 작업을 말한다. 이는 스케줄링 또는 인터럽트에 의해 발생한다. 

- **스케줄링** : 운영체제는 여러 스레드에 CPU시간을 할당하며, 해당 시간을 전부 사용하면 CPU 실행기회를 다른 스레드에게 전환한다.
- **인터럽트** : 요청에 의해 발생한다. 입출력 완료, 타이머 인터럽트 등에 의해 발생하고 실행중이던 스레드의 상태를 저장하고 다른 스레드로 전환한다. (Sleep, Yield 동작도 인터럽트 유형에 해당)

컨텍스트 스위칭은 현재 실행중이던 스레드의 상태(레지스터 값, 프로그램 카운터, 스택 포인터 등의 관련 정보)를 저장하고 CPU 제어권을 전달받은 다른 스레드의 상태 정보를 복원하는 작업을 모두 수행해야 한다. 

이러한 점에 의해 스위칭이 빈번하게 발생하면 시스템의 성능에 부하를 주게 된다. **(부하가 생각보다 큰 편에 속하므로 스위칭이 발생하지 않는 스핀락의 성능이 좋다고 보는 것이다)**

```
인프런 Rookiss 강사님 로드맵 'C#과 유니티로 만드는 MMORPG 게임 개발 시리즈'에 대한 학습을 진행하면서 작성한 개인 기록용 강의노트입니다.
```
